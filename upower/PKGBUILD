# POWER Maintainer: Alexander Baldeck <alex.bldck@gmail.com>
# Maintainer: Jan Alexander Steffens (heftig) <heftig@archlinux.org>
# Maintainer: Jan de Groot <jgc@archlinux.org>

pkgname=upower
pkgver=0.99.15
pkgrel=1
pkgdesc="Abstraction for enumerating power devices, listening to device events and querying history and statistics"
url="https://upower.freedesktop.org"
arch=(x86_64 powerpc64le powerpc riscv64)
license=(GPL)
depends=(systemd libimobiledevice libgudev)
makedepends=(docbook-xsl gobject-introspection python git gtk-doc meson)
checkdepends=(python-{dbus,dbusmock,gobject} umockdev)
backup=(etc/UPower/UPower.conf)
_commit=e4a8656521775a67e099a5a784364c2d2fd51a4a  # tags/v0.99.15^0
source=("git+https://gitlab.freedesktop.org/upower/upower.git#commit=$_commit"
        0001-build-Fix-default-udevrulesdir.patch
        0002-build-Fix-version-macros.patch)
sha256sums=('SKIP'
            '8891e9baddca739f41a9323da94fd38c61f42e9267b0b42597f69fb3f4d8bf69'
            '68a916b1058dcc7b21e8e7568e6998bf929bb586b94500124739c1059107e256')

pkgver() {
  cd upower
  git describe --tags | sed -e 's/^v\|^UPOWER_//;s/_/\./g;s/[^-]*-g/r&/;s/-/+/g'
}

prepare() {
  cd upower

  # meson fixes
  git apply -3 ../0001-build-Fix-default-udevrulesdir.patch
  git apply -3 ../0002-build-Fix-version-macros.patch
}

build() {
  arch-meson upower build
  meson compile -C build
}

check() {
  meson test -C build --print-errorlogs
}

package() {
  depends+=(libg{lib,object,io}-2.0.so)
  provides+=(libupower-glib.so)

  meson install -C build --destdir "$pkgdir"
}
