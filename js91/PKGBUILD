# POWER Maintainer: Alexander Baldeck <alex.bldck@gmail.com>
# Maintainer: Jan Alexander Steffens (heftig) <heftig@archlinux.org>

pkgname=js91
pkgver=91.13.0
pkgrel=2
pkgdesc="JavaScript interpreter and libraries - Version 91"
arch=(x86_64 powerpc64le powerpc riscv64)
url="https://spidermonkey.dev/"
license=(MPL)
depends=(gcc-libs readline zlib sh)
makedepends=(zip autoconf2.13 python-setuptools python-psutil rust llvm clang
             pulseaudio cbindgen unzip libxt)
makedepends_powerpc64le=(lld)
makedepends_powerpc=(nodejs-lts-dubnium gtk3 dbus-glib)
checkdepends=(mercurial git)
options=(!lto !debug !distcc)
_relver=${pkgver}esr
source=(https://archive.mozilla.org/pub/firefox/releases/$_relver/source/firefox-$_relver.source.tar.xz{,.asc}
        fix-build-ppc32.patch
        https://dev.gentoo.org/~juippis/mozilla/patchsets/firefox-91esr-patches-10j.tar.xz
        https://dev.gentoo.org/~juippis/mozilla/patchsets/spidermonkey-91-patches-04j.tar.xz)
sha256sums=('53be2bcde0b5ee3ec106bd8ba06b8ae95e7d489c484e881dfbe5360e4c920762'
            'SKIP'
            '840b483685b023cd112f30d61e7381b917a0e5146dcd13e282d2193b2d1c5b6f'
            'c16268128753601d9351fab61126dc5690ac62758f5daa5decc188da1c50107d'
            '2948cad56743930b406c48bd1012590c794cb79123ad7aa4e003a2c3bb59fc90')
validpgpkeys=('14F26682D0916CDD81E37B6D61B7B526D98F0353') # Mozilla Software Releases <release@mozilla.com>

# Make sure the duplication between bin and lib is found
COMPRESSZST+=(--long)

prepare() {
  mkdir mozbuild
  cd firefox-$pkgver

  patch -Np1 -i ${srcdir}/fix-build-ppc32.patch

  for fn in ../{firefox,spidermonkey}-patches/*.patch; do
    msg "Applying patch ${fn}..."
    patch -Np1 -i ${fn}
  done

  cat >../mozconfig <<END
ac_add_options --enable-application=js
mk_add_options MOZ_OBJDIR=${PWD@Q}/obj
mk_add_options MOZ_MAKE_FLAGS="${MAKEFLAGS}"

ac_add_options --prefix=/usr
ac_add_options --enable-release
ac_add_options --enable-hardening
ac_add_options --enable-optimize
ac_add_options --enable-rust-simd
ac_add_options --enable-linker=lld
ac_add_options --disable-bootstrap
ac_add_options --disable-debug
ac_add_options --disable-debug-symbols
ac_add_options --disable-jemalloc
ac_add_options --disable-strip

# System libraries
ac_add_options --with-system-zlib
ac_add_options --with-system-icu

# Features
ac_add_options --enable-readline
ac_add_options --enable-shared-js
ac_add_options --enable-tests
ac_add_options --with-intl-api
END
}

build() {
  cd firefox-$pkgver

  export MOZ_NOSPAM=1
  export MOZBUILD_STATE_PATH="$srcdir/mozbuild"
  export MACH_USE_SYSTEM_PYTHON=1

  case "${CARCH}" in
    powerpc64le|x86_64)
      export CC=clang
      export CXX=clang++
      # Do 3-tier PGO
      echo "Building instrumented JS..."
      cat >.mozconfig ../mozconfig - <<END
ac_add_options --enable-profile-generate=cross
ac_add_options --enable-linker=lld
END
      ./mach build

      echo "Profiling instrumented JS..."
      (
        local js="$PWD/obj/dist/bin/js"
        export LLVM_PROFILE_FILE="$PWD/js-%p-%m.profraw"

        cd js/src/octane
        "$js" run.js

        cd ../../../third_party/webkit/PerformanceTests/ARES-6
        "$js" cli.js

        cd ../SunSpider/sunspider-0.9.1
        "$js" sunspider-standalone-driver.js
      )

      llvm-profdata merge -o merged.profdata *.profraw

      stat -c "Profile data found (%s bytes)" merged.profdata
      test -s merged.profdata

      echo "Removing instrumented JS..."
      ./mach clobber

      echo "Building optimized JS..."
      cat >.mozconfig ../mozconfig - <<END
ac_add_options --enable-lto=cross
ac_add_options --enable-profile-use=cross
ac_add_options --with-pgo-profile-path=${PWD@Q}/merged.profdata
ac_add_options --enable-linker=lld
END
    ;;
    *)
      export CC=gcc
      export CXX=g++
      cat >.mozconfig ../mozconfig - <<END
ac_add_options --enable-linker=bfd
ac_add_options --disable-jit
END
      cat .mozconfig
      sleep 10
    ;;
  esac

  case "${CARCH}" in
    powerpc)
      export CXXFLAGS+=" -Wno-class-memaccess"
      export LDFLAGS+=" -Wl,-z,stack-size=1048576 -latomic"
    ;;
  esac

  ./mach build
}

check() {
  local jstests_extra_args=(
    --format=none
    --exclude-random
    --wpt=disabled
  ) jittest_extra_args=(
    --format=none
    --timeout 300
  ) jittest_test_args=(
    basic
  )

  cd firefox-$pkgver/obj
  make -C js/src check-jstests check-jit-test \
    JSTESTS_EXTRA_ARGS="${jstests_extra_args[*]}" \
    JITTEST_EXTRA_ARGS="${jittest_extra_args[*]}" \
    JITTEST_TEST_ARGS="${jittest_test_args[*]}"
}

package() {
  cd firefox-$pkgver/obj
  make DESTDIR="$pkgdir" install
  rm "$pkgdir"/usr/lib/*.ajs
  find "$pkgdir"/usr/{lib/pkgconfig,include} -type f -exec chmod -c a-x {} +
}

# vim:set sw=2 et:
